<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sentra Stat Monitor - Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/assets/sentra_amblem.png" type="image/x-icon">
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <style>
    html,
    body {
      height: 100%;
      overflow: hidden;
    }
    body {
      background: #020617;
      color: #ffffff;
    }
    .navbar-grafana {
      background: #0c0f14;
      border-bottom: 1px solid #374151;
      flex-shrink: 0;
    }
    .terminal-container {
      display: flex;
      flex-direction: column;
      height: 100%;
      background: #000000;
      color: #00ff9c;
      font-family: 'Courier New', Courier, monospace;
      font-size: 13px;
      line-height: 1.5;
      border: 1px solid #374151;
      margin: 12px;
      border-radius: 4px;
      overflow: hidden;
    }
    .terminal-header {
      background: #0c0f14;
      padding: 8px 12px;
      border-bottom: 1px solid #374151;
      font-size: 11px;
      color: #9ca3af;
      flex-shrink: 0;
    }
    .terminal-output {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      white-space: pre-wrap;
      word-wrap: break-word;
      outline: none;
    }
    .terminal-output::-webkit-scrollbar {
      width: 8px;
    }
    .terminal-output::-webkit-scrollbar-track {
      background: #000000;
    }
    .terminal-output::-webkit-scrollbar-thumb {
      background: #374151;
      border-radius: 4px;
    }
    .terminal-output::-webkit-scrollbar-thumb:hover {
      background: #4b5563;
    }
    .terminal-input-line {
      display: flex;
      gap: 4px;
    }
    .terminal-prompt {
      color: #00ff9c;
      flex-shrink: 0;
    }
    .terminal-input-field {
      flex: 1;
      background: transparent;
      border: none;
      color: #00ff9c;
      outline: none;
      font-family: 'Courier New', Courier, monospace;
      font-size: 13px;
      padding: 0;
      margin: 0;
    }
    .terminal-input-field::placeholder {
      color: #6b7280;
    }
    .error-line {
      color: #ff6b6b;
    }
    .success-line {
      color: #4ade80;
    }
    .output-line {
      color: #e5e7eb;
    }
    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
  </style>
</head>
<body>
  <div class="d-flex flex-column min-vh-100">
    <nav class="navbar navbar-grafana navbar-expand-lg text-light">
      <div class="container-fluid px-3">
        <div class="d-flex align-items-center gap-2">
          <img
            src="/assets/whitesentra_logo2.png"
            alt="Sentra logo"
            style="height: 156px"
          />
        </div>
        <div class="d-flex align-items-center gap-2">
          <button
            id="go-dashboard-btn"
            class="btn btn-sm btn-outline-light"
            type="button"
          >
            Back to dashboard
          </button>
          <button
            id="logout-btn"
            class="btn btn-sm btn-outline-danger"
            type="button"
          >
            Logout
          </button>
        </div>
      </div>
    </nav>

    <main>
      <div class="terminal-container">
        <div class="terminal-header">
          user@sentra-monitor:~# (restricted environment - dangerous commands are blocked)
        </div>
        <div id="terminal-output" class="terminal-output"></div>
      </div>
    </main>
  </div>

  <script>
    const logoutBtn = document.getElementById("logout-btn");
    const goDashboardBtn = document.getElementById("go-dashboard-btn");
    const outputEl = document.getElementById("terminal-output");

    const WELCOME_MESSAGE =
      "Welcome to Sentra Console\n" +
      "Type 'help' for available commands, 'clear' to clear the screen\n" +
      "\n";

    let commandHistory = [];
    let historyIndex = -1;
    let currentInput = "";

    // Initialize terminal
    function initTerminal() {
      outputEl.innerHTML = "";
      appendOutput(WELCOME_MESSAGE);
      createInputLine();
    }

    function appendOutput(text) {
      const lines = text.split("\n");
      lines.forEach((line) => {
        if (line) {
          const span = document.createElement("div");
          span.className = "output-line";
          span.textContent = line;
          outputEl.appendChild(span);
        } else {
          outputEl.appendChild(document.createElement("div"));
        }
      });
      outputEl.scrollTop = outputEl.scrollHeight;
    }

    function appendErrorOutput(text) {
      const lines = text.split("\n");
      lines.forEach((line) => {
        if (line) {
          const span = document.createElement("div");
          span.className = "error-line";
          span.textContent = line;
          outputEl.appendChild(span);
        }
      });
      outputEl.scrollTop = outputEl.scrollHeight;
    }

    function createInputLine() {
      const inputLine = document.createElement("div");
      inputLine.className = "terminal-input-line";
      inputLine.id = "current-input-line";

      const prompt = document.createElement("span");
      prompt.className = "terminal-prompt";
      prompt.textContent = "$ ";

      const input = document.createElement("input");
      input.type = "text";
      input.id = "terminal-input";
      input.className = "terminal-input-field";
      input.placeholder = "";
      input.autocomplete = "off";
      input.spellcheck = "false";

      inputLine.appendChild(prompt);
      inputLine.appendChild(input);
      outputEl.appendChild(inputLine);

      input.focus();
      outputEl.scrollTop = outputEl.scrollHeight;

      input.addEventListener("keydown", handleKeyDown);
    }

    function handleKeyDown(e) {
      const input = e.target;

      if (e.key === "Enter") {
        e.preventDefault();
        const command = input.value.trim();
        executeCommand(command);
      } else if (e.key === "ArrowUp") {
        e.preventDefault();
        if (historyIndex < commandHistory.length - 1) {
          historyIndex++;
          currentInput = input.value;
          input.value = commandHistory[commandHistory.length - 1 - historyIndex];
        }
      } else if (e.key === "ArrowDown") {
        e.preventDefault();
        if (historyIndex > 0) {
          historyIndex--;
          input.value = commandHistory[commandHistory.length - 1 - historyIndex];
        } else if (historyIndex === 0) {
          historyIndex = -1;
          input.value = currentInput;
        }
      } else if (e.key === "Tab") {
        e.preventDefault();
      }
    }

    async function executeCommand(command) {
      const inputLine = document.getElementById("current-input-line");
      const input = document.getElementById("terminal-input");

      // Display the command
      if (command) {
        const cmdLine = document.createElement("div");
        cmdLine.className = "terminal-input-line";
        const cmdPrompt = document.createElement("span");
        cmdPrompt.className = "terminal-prompt";
        cmdPrompt.textContent = "$ ";
        const cmdText = document.createElement("span");
        cmdText.style.color = "#00ff9c";
        cmdText.textContent = command;
        cmdLine.appendChild(cmdPrompt);
        cmdLine.appendChild(cmdText);

        outputEl.replaceChild(cmdLine, inputLine);
      }

      // Handle local commands
      if (command.toLowerCase() === "clear") {
        outputEl.innerHTML = "";
        appendOutput("");
        historyIndex = -1;
        currentInput = "";
        createInputLine();
        return;
      }

      if (command.toLowerCase() === "help") {
        appendOutput(
          "Available commands:\n" +
          "  help          - Show this help message\n" +
          "  clear         - Clear the terminal\n" +
          "  whoami        - Show current user\n" +
          "  pwd           - Show current directory\n" +
          "  ls            - List files (with flags supported)\n" +
          "  cat           - Display file contents\n" +
          "  echo          - Print text\n" +
          "  date          - Show current date/time\n" +
          "  uname         - Show system information\n" +
          "\nNote: Some commands are blocked for security reasons.\n"
        );
        createInputLine();
        return;
      }

      if (!command) {
        createInputLine();
        return;
      }

      // Add to history
      commandHistory.push(command);
      historyIndex = -1;
      currentInput = "";

      try {
        const res = await fetch("/api/console/exec", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ command }),
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok || !data.success) {
          const msg = data && data.error ? data.error : "Command failed.";
          appendErrorOutput(msg);
          createInputLine();
          return;
        }

        const stdout = data.stdout || "";
        const stderr = data.stderr || "";

        if (stdout) {
          appendOutput(stdout);
        }
        if (stderr) {
          appendErrorOutput(stderr);
        }
        if (!stdout && !stderr) {
          appendOutput("");
        }

        createInputLine();
      } catch (err) {
        console.error(err);
        appendErrorOutput("Network error: " + err.message);
        createInputLine();
      }
    }

    if (logoutBtn) {
      logoutBtn.addEventListener("click", async () => {
        try {
          await fetch("/logout", { method: "POST" });
        } catch (e) {
          console.error(e);
        }
        window.location.href = "/login";
      });
    }

    if (goDashboardBtn) {
      goDashboardBtn.addEventListener("click", () => {
        window.location.href = "/";
      });
    }

    // Click anywhere in terminal to focus input
    outputEl.addEventListener("click", () => {
      const input = document.getElementById("terminal-input");
      if (input) input.focus();
    });

    // Initialize on load
    initTerminal();
  </script>
</body>
</html>
