<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sentra Stat Monitor - Uygulamalar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/assets/sentra_amblem.png" type="image/x-icon">
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <style>
    body { background: #151824; color: #e5e7eb; }
    .navbar-grafana { background: #0f131d; border-bottom: 1px solid #2d3748; }
    .server-info {
      font-size: 12px;
      color: #9ca3af;
      display: flex;
      gap: 15px;
      margin-right: auto;
      margin-left: 20px;
      padding-left: 20px;
      border-left: 1px solid #2d3748;
    }
    .server-info-item { display: flex; align-items: center; gap: 5px; }
    .server-info-item strong { color: #d1d5db; }
    .card-grafana {
      background: #1a202d;
      border: 1px solid #2d3748;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }
    .card-header-grafana {
      background: #16202f;
      border-bottom: 1px solid #2d3748;
    }
    .table-dark { 
      color: #e5e7eb;
      background: #1a202d;
    }
    .table-dark thead th { 
      background: #16202f;
      color: #9ca3af; 
      font-weight: 600;
      border-color: #2d3748;
    }
    .table-dark tbody tr {
      background: #1a202d;
      border-color: #2d3748;
    }
    .table-dark tbody tr:hover {
      background: #22293d;
      cursor: pointer;
    }
    .table-dark tbody td {
      border-color: #2d3748;
      vertical-align: middle;
    }
    /* Kolon renklemeleri */
    .col-id {
      color: #60a5fa;
      font-weight: 500;
    }
    .col-app-id {
      color: #34d399;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
    }
    .col-hostname {
      color: #fbbf24;
      font-weight: 500;
    }
    .col-os {
      color: #c084fc;
    }
    .col-last-seen {
      color: #f87171;
    }
    .col-created {
      color: #93c5fd;
    }
    .text-secondary,
    .text-muted,
    .small {
      color: #9ca3af !important;
    }
  </style>
</head>
<body>
   <nav class="navbar navbar-grafana navbar-expand-lg text-light">
      <div class="container-fluid px-3">
        <div class="d-flex align-items-center gap-2">
          <img
            src="/assets/whitesentra_logo2.png"
            alt="Sentra logo"
            style="height: 156px"
          />
        </div>
        <div class="d-flex align-items-center gap-2">
          <button id="dashboard-btn" class="btn btn-sm btn-outline-light" type="button">Windows Agent Dashboard</button>
          <button id="console-btn" class="btn btn-sm btn-outline-light" type="button">Web Console</button>
          <button id="user-settings-btn" class="btn btn-sm btn-outline-light" type="button">User settings</button>
          <button
            id="logout-btn"
            class="btn btn-sm btn-outline-danger"
            type="button"
          >
            Logout
          </button>
        </div>
      </div>
    </nav>

  <main class="container mt-4 mb-4">
    <h4 class="mb-3">Uygulama (Agent) Tanımları</h4>

    <div class="card card-grafana shadow-sm mb-4">
      <div class="card-header-grafana fw-semibold">Yeni Uygulama Ekle</div>
      <div class="card-body">
        <p class="text-muted" style="font-size: 13px;">
          Agent tarafındaki App ID (GUID) bilgisini girerek kendi hesabınıza bağlayın.
        </p>
        <form id="app-form" class="row g-3">
          <div class="col-12 col-md-8">
            <label class="form-label text-muted">App ID</label>
            <input class="form-control" name="app_id" required placeholder="e.g. 123e4567-e89b-12d3-a456-426614174000" />
          </div>
          <div class="col-12 col-md-4 d-flex align-items-end">
            <button class="btn btn-primary w-100" type="submit">Uygulamayı Tanımla</button>
          </div>
        </form>
      </div>
    </div>

    <div class="card card-grafana shadow-sm">
      <div class="card-header-grafana d-flex justify-content-between align-items-center">
        <span class="fw-semibold">Tanımlı Uygulamalarım</span>
        <span id="apps-count" class="badge text-bg-secondary">0</span>
      </div>
      <div class="table-responsive">
        <table class="table table-dark table-sm align-middle mb-0">
          <thead>
            <tr>
              <th style="color: #60a5fa;">ID</th>
              <th style="color: #34d399;">App ID</th>
              <th style="color: #fbbf24;">Hostname</th>
              <th style="color: #c084fc;">OS</th>
              <th style="color: #f87171;">Son Görülme</th>
              <th style="color: #93c5fd;">Oluşturulma</th>
            </tr>
          </thead>
          <tbody id="apps-body">
            <tr><td colspan="6" class="text-center text-muted">Yükleniyor...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <script>
    
    async function fetchJson(url, opts = {}) {
      const res = await fetch(url, { credentials: "include", ...opts });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    async function loadApps() {
      try {
        const res = await fetchJson("/api/agents");
        const data = res.data || [];
        document.getElementById("apps-count").textContent = data.length;
        const body = document.getElementById("apps-body");
        if (!data.length) {
          body.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Bu kullanıcı için tanımlı uygulama yok.</td></tr>';
          return;
        }
        body.innerHTML = data.map(a => `
          <tr>
            <td class="col-id">${a.id}</td>
            <td class="col-app-id">${a.app_id}</td>
            <td class="col-hostname">${a.hostname || "-"}</td>
            <td class="col-os">${a.os || "-"}</td>
            <td class="col-last-seen">${a.last_seen || "-"}</td>
            <td class="col-created">${a.created_at}</td>
          </tr>
        `).join("");
      } catch (err) {
        alert("Veriler alınamadı: " + err.message);
      }
    }

    document.getElementById("app-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);
      const app_id = formData.get("app_id");
      try {
        const res = await fetchJson("/api/apps", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ app_id }),
        });
        alert(res.message || "Uygulama tanımlandı");
        form.reset();
        loadApps();
      } catch (err) {
        alert("Kayıt yapılamadı: " + err.message);
      }
    });

    // Navigation initialization
    async function initNav() {
      const logoutBtn = document.getElementById("logout-btn");
      const userSettingsBtn = document.getElementById("user-settings-btn");
      const consoleBtn = document.getElementById("console-btn");
      const dashboardBtn = document.getElementById("dashboard-btn");

      if (logoutBtn) {
        logoutBtn.addEventListener("click", async () => {
          try { await fetch("/logout", { method: "POST" }); } catch (e) { console.error(e); }
          window.location.href = "/login";
        });
      }
      if (userSettingsBtn) {
        userSettingsBtn.addEventListener("click", () => { window.location.href = "/user-settings"; });
      }
      if (consoleBtn) {
        consoleBtn.addEventListener("click", () => { window.location.href = "/console"; });
      }
      if (dashboardBtn) {
        dashboardBtn.addEventListener("click", () => { window.location.href = "/dashboard"; });
      }
    }

    initNav();
    loadApps();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
