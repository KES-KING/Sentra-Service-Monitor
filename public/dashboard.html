<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sentra Stat Monitor - Agents</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/assets/sentra_amblem.png" type="image/x-icon">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    html, body { 
      height: 100%; 
    }
    body { 
      background: #151824; 
      color: #e5e7eb; 
    }
    .navbar-grafana { 
      background: #0f131d; 
      border-bottom: 1px solid #2d3748; 
    }
    .server-info {
      font-size: 12px; 
      color: #9ca3af; 
      display: flex; 
      gap: 15px;
      margin-right: auto; 
      margin-left: 20px; 
      padding-left: 20px;
      border-left: 1px solid #2d3748;
    }
    .server-info-item { 
      display: flex; 
      align-items: center; 
      gap: 5px; 
    }
    .server-info-item strong { 
      color: #d1d5db; 
    }
    .card-grafana {
      background: #1a202d;
      border: 1px solid #2d3748;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }
    .card-header-grafana {
      background: #16202f;
      border-bottom: 1px solid #2d3748;
    }
    .table-dark { 
      color: #e5e7eb; 
    }
    .table-dark thead th { 
      background: #16202f;
      color: #9ca3af; 
      font-weight: 600;
      border-color: #2d3748;
    }
    .table-dark tbody tr {
      background: #1a202d;
      border-color: #2d3748;
    }
    .table-dark tbody tr:hover {
      background: #22293d;
      cursor: pointer;
    }
    .table-dark tbody td {
      color: #d1d5db;
      border-color: #2d3748;
      vertical-align: middle;
    }
    .text-secondary,
    .text-muted,
    .small {
      color: #9ca3af !important;
    }
    .pagination-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border-top: 1px solid #2d3748;
      background: #16202f;
      font-size: 12px;
    }
    .btn-pagination {
      padding: 4px 12px;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="d-flex flex-column min-vh-100">
    <nav class="navbar navbar-grafana navbar-expand-lg text-light">
      <div class="container-fluid px-3">
        <div class="d-flex align-items-center gap-2">
          <img
            src="/assets/whitesentra_logo2.png"
            alt="Sentra logo"
            style="height: 156px"
          />
        </div>
        <div class="server-info" id="server-info">
          <div class="server-info-item">
            <strong>IP:</strong>
            <span id="server-ip">-</span>
          </div>
          <div class="server-info-item">
            <strong>Hostname:</strong>
            <span id="server-hostname">-</span>
          </div>
          <div class="server-info-item">
            <strong>OS:</strong>
            <span id="server-os">-</span>
          </div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <button id="dashboard-btn" class="btn btn-sm btn-outline-light" type="button">Windows Agent Dashboard</button>
          <button id="apps-btn" class="btn btn-sm btn-outline-light" type="button">Agent Credentials</button>
          <button id="console-btn" class="btn btn-sm btn-outline-light" type="button">Web Console</button>
          <button id="user-settings-btn" class="btn btn-sm btn-outline-light" type="button">User settings</button>
          <button id="logout-btn" class="btn btn-sm btn-outline-danger" type="button">Logout</button>
        </div>
      </div>
    </nav>

    <main class="flex-fill">
      <div class="container-fluid px-3 py-2 h-100 d-flex flex-column">
        <!-- Header -->
        <div class="row g-2 mb-2 align-items-end">
          <div class="col-12 col-lg-8 d-flex justify-content-between small text-secondary">
            <span>Agents & Services Overview</span>
            <span id="last-updated">Last update: pending...</span>
          </div>
          <div class="col-12 col-lg-4 d-flex justify-content-end">
            <div class="d-flex gap-2 align-items-center">
              <label for="host-filter" class="text-muted small mb-0">Hostname filter:</label>
              <select id="host-filter" class="form-select form-select-sm" style="max-width: 240px;">
                <option value="">All</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Main grid -->
        <div class="row g-2 flex-fill">
          <!-- Agents & Status -->
          <div class="col-lg-6 d-flex">
            <div class="card card-grafana w-100 d-flex flex-column">
              <div class="card-header card-header-grafana d-flex justify-content-between align-items-center">
                <span class="fw-semibold">Registered Agents</span>
                <span id="agents-count" class="badge text-bg-secondary">0</span>
              </div>
              <div class="table-responsive flex-grow-1 d-flex flex-column">
                <table class="table table-dark table-sm align-middle mb-0">
                  <thead>
                    <tr>
                      <th>ID</th><th>App ID</th><th>Hostname</th><th>OS</th><th>Last Seen</th><th>Created</th>
                    </tr>
                  </thead>
                  <tbody id="agents-body">
                    <tr><td colspan="6" class="text-center text-muted">Loading...</td></tr>
                  </tbody>
                </table>
              </div>
              <div class="pagination-controls">
                <span id="agents-pagination" class="text-secondary">Page 1</span>
                <div class="btn-group btn-group-sm">
                  <button id="agents-prev-btn" class="btn btn-outline-secondary btn-pagination" type="button">Prev</button>
                  <button id="agents-next-btn" class="btn btn-outline-secondary btn-pagination" type="button">Next</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Status Updates -->
          <div class="col-lg-6 d-flex">
            <div class="card card-grafana w-100 d-flex flex-column">
              <div class="card-header card-header-grafana d-flex justify-content-between align-items-center">
                <span class="fw-semibold">Last 50 Status Updates</span>
                <span id="status-count" class="badge text-bg-secondary">0</span>
              </div>
              <div class="table-responsive flex-grow-1 d-flex flex-column">
                <table class="table table-dark table-sm align-middle mb-0">
                  <thead>
                    <tr>
                      <th>ID</th><th>Agent ID</th><th>App ID</th><th>Hostname</th><th>CPU</th><th>RAM</th><th>Uptime</th><th>Time</th>
                    </tr>
                  </thead>
                  <tbody id="status-body">
                    <tr><td colspan="8" class="text-center text-muted">Loading...</td></tr>
                  </tbody>
                </table>
              </div>
              <div class="pagination-controls">
                <span id="status-pagination" class="text-secondary">Page 1</span>
                <div class="btn-group btn-group-sm">
                  <button id="status-prev-btn" class="btn btn-outline-secondary btn-pagination" type="button">Prev</button>
                  <button id="status-next-btn" class="btn btn-outline-secondary btn-pagination" type="button">Next</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Services -->
        <div class="row g-2 flex-fill mt-2">
          <div class="col-12 d-flex">
            <div class="card card-grafana w-100 d-flex flex-column">
              <div class="card-header card-header-grafana d-flex justify-content-between align-items-center">
                <span class="fw-semibold">Service Status</span>
                <span id="services-count" class="badge text-bg-secondary">0</span>
              </div>
              <div class="table-responsive flex-grow-1 d-flex flex-column">
                <table class="table table-dark table-sm align-middle mb-0">
                  <thead>
                    <tr>
                      <th>Agent ID</th><th>App ID</th><th>Hostname</th><th>Service</th><th>Display Name</th><th>Status</th><th>Last Updated</th><th class="text-end">Action</th>
                    </tr>
                  </thead>
                  <tbody id="services-body">
                    <tr><td colspan="8" class="text-center text-muted">Loading...</td></tr>
                  </tbody>
                </table>
              </div>
              <div class="pagination-controls">
                <span id="services-pagination" class="text-secondary">Page 1</span>
                <div class="btn-group btn-group-sm">
                  <button id="services-prev-btn" class="btn btn-outline-secondary btn-pagination" type="button">Prev</button>
                  <button id="services-next-btn" class="btn btn-outline-secondary btn-pagination" type="button">Next</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    const PAGE_SIZE = 10;
    let agentsData = [];
    let agentsCurrentPage = 1;
    let statusData = [];
    let statusCurrentPage = 1;
    let servicesData = [];
    let servicesCurrentPage = 1;
    let hostFilter = "";
    let allAgents = [];
    let allStatus = [];
    let allServices = [];

    async function fetchJson(url, opts = {}) {
      const res = await fetch(url, { credentials: "include", ...opts });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    function paginateData(data, currentPage) {
      const totalPages = Math.max(1, Math.ceil(data.length / PAGE_SIZE));
      if (currentPage > totalPages) currentPage = totalPages;
      const start = (currentPage - 1) * PAGE_SIZE;
      const pageData = data.slice(start, start + PAGE_SIZE);
      return { pageData, totalPages, currentPage };
    }

    function renderAgents(data) {
      agentsData = data;
      agentsCurrentPage = 1;
      updateAgentsTable();
    }

    function updateAgentsTable() {
      const body = document.getElementById("agents-body");
      const pagination = document.getElementById("agents-pagination");
      const prevBtn = document.getElementById("agents-prev-btn");
      const nextBtn = document.getElementById("agents-next-btn");
      
      document.getElementById("agents-count").textContent = agentsData.length;
      
      if (!agentsData.length) {
        body.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No agents registered yet.</td></tr>';
        pagination.textContent = "No data";
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        return;
      }
      
      const { pageData, totalPages, currentPage } = paginateData(agentsData, agentsCurrentPage);
      agentsCurrentPage = currentPage;
      
      pagination.textContent = `Page ${currentPage} of ${totalPages}`;
      prevBtn.disabled = currentPage <= 1;
      nextBtn.disabled = currentPage >= totalPages;
      
      body.innerHTML = pageData.map(a => `
        <tr>
          <td>${a.id}</td>
          <td class="font-monospace">${a.app_id}</td>
          <td>${a.hostname || "-"}</td>
          <td class="text-muted">${a.os || "-"}</td>
          <td>${a.last_seen || "-"}</td>
          <td class="text-muted">${a.created_at}</td>
        </tr>
      `).join("");
    }

    function renderStatus(data) {
      statusData = data;
      statusCurrentPage = 1;
      updateStatusTable();
    }

    function updateStatusTable() {
      const body = document.getElementById("status-body");
      const pagination = document.getElementById("status-pagination");
      const prevBtn = document.getElementById("status-prev-btn");
      const nextBtn = document.getElementById("status-next-btn");
      
      document.getElementById("status-count").textContent = statusData.length;
      
      if (!statusData.length) {
        body.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No status records available.</td></tr>';
        pagination.textContent = "No data";
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        return;
      }
      
      const { pageData, totalPages, currentPage } = paginateData(statusData, statusCurrentPage);
      statusCurrentPage = currentPage;
      
      pagination.textContent = `Page ${currentPage} of ${totalPages}`;
      prevBtn.disabled = currentPage <= 1;
      nextBtn.disabled = currentPage >= totalPages;
      
      body.innerHTML = pageData.map(s => `
        <tr>
          <td>${s.id}</td>
          <td>${s.agent_id}</td>
          <td class="font-monospace">${s.app_id}</td>
          <td>${s.hostname || "-"}</td>
          <td>${s.cpu ?? "-"}</td>
          <td>${s.ram ?? "-"}</td>
          <td>${s.uptime ?? "-"}</td>
          <td class="text-muted">${s.timestamp || "-"}</td>
        </tr>
      `).join("");
    }

    function renderServices(data) {
      servicesData = data;
      servicesCurrentPage = 1;
      updateServicesTable();
    }

    function updateServicesTable() {
      const body = document.getElementById("services-body");
      const pagination = document.getElementById("services-pagination");
      const prevBtn = document.getElementById("services-prev-btn");
      const nextBtn = document.getElementById("services-next-btn");
      
      document.getElementById("services-count").textContent = servicesData.length;
      
      if (!servicesData.length) {
        body.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No service information available.</td></tr>';
        pagination.textContent = "No data";
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        return;
      }
      
      const { pageData, totalPages, currentPage } = paginateData(servicesData, servicesCurrentPage);
      servicesCurrentPage = currentPage;
      
      pagination.textContent = `Page ${currentPage} of ${totalPages}`;
      prevBtn.disabled = currentPage <= 1;
      nextBtn.disabled = currentPage >= totalPages;
      
      body.innerHTML = pageData.map(r => `
        <tr>
          <td>${r.agent_id}</td>
          <td class="font-monospace">${r.app_id}</td>
          <td>${r.hostname || "-"}</td>
          <td>${r.service_name}</td>
          <td class="text-muted">${r.display_name || "-"}</td>
          <td>${r.status || "-"}</td>
          <td class="text-muted">${r.last_updated || "-"}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-warning" onclick="queueRestart(${r.agent_id}, '${r.service_name}')">Restart</button>
          </td>
        </tr>
      `).join("");
    }

    async function queueRestart(agentId, serviceName) {
      try {
        await fetchJson(`/api/agent-services/${agentId}/${encodeURIComponent(serviceName)}/restart`, { method: "POST" });
        alert("Restart command queued successfully.");
      } catch (err) {
        alert("Failed to queue restart command: " + err.message);
      }
    }

    async function loadAll() {
      try {
        const [agents, status, services] = await Promise.all([
          fetchJson("/api/agents"),
          fetchJson("/api/agent-status"),
          fetchJson("/api/agent-services"),
        ]);
        allAgents = agents.data || [];
        allStatus = status.data || [];
        allServices = services.data || [];
        populateHostFilter(allAgents);
        applyHostFilter();
        document.getElementById("last-updated").textContent = "Last update: " + new Date().toLocaleTimeString();
      } catch (err) {
        console.error(err);
        alert("Failed to load data: " + err.message);
      }
    }

    function populateHostFilter(agents) {
      const select = document.getElementById("host-filter");
      const current = select.value;
      const hostnames = Array.from(new Set(agents.map(a => a.hostname).filter(Boolean))).sort();
      select.innerHTML = '<option value="">All</option>' + hostnames.map(h => `<option value="${h}">${h}</option>`).join("");
      if (current && hostnames.includes(current)) {
        select.value = current;
        hostFilter = current;
      } else {
        hostFilter = "";
        select.value = "";
      }
      select.onchange = () => {
        hostFilter = select.value;
        applyHostFilter();
      };
    }

    function applyHostFilter() {
      const agentFiltered = hostFilter ? allAgents.filter(a => (a.hostname || "") === hostFilter) : allAgents;
      const statusFiltered = hostFilter ? allStatus.filter(s => (s.hostname || "") === hostFilter) : allStatus;
      const servicesFiltered = hostFilter ? allServices.filter(s => (s.hostname || "") === hostFilter) : allServices;
      renderAgents(agentFiltered);
      renderStatus(statusFiltered);
      renderServices(servicesFiltered);
    }

    async function initNav() {
      const logoutBtn = document.getElementById("logout-btn");
      const userSettingsBtn = document.getElementById("user-settings-btn");
      const consoleBtn = document.getElementById("console-btn");
      const dashboardBtn = document.getElementById("dashboard-btn");
      const appsBtn = document.getElementById("apps-btn");

      if (logoutBtn) {
        logoutBtn.addEventListener("click", async () => {
          try { await fetch("/logout", { method: "POST" }); } catch (e) { console.error(e); }
          window.location.href = "/login";
        });
      }
      if (userSettingsBtn) {
        userSettingsBtn.addEventListener("click", () => { window.location.href = "/user-settings"; });
      }
      if (consoleBtn) {
        consoleBtn.addEventListener("click", () => { window.location.href = "/console"; });
      }
      if (dashboardBtn) {
        dashboardBtn.addEventListener("click", () => { window.location.href = "/dashboard"; });
      }
      if (appsBtn) {
        appsBtn.addEventListener("click", () => { window.location.href = "/apps"; });
      }

      try {
        const res = await fetch("/api/server-info");
        const data = await res.json();
        if (data.success) {
          document.getElementById("server-ip").textContent = data.ipAddress || "-";
          document.getElementById("server-hostname").textContent = data.hostname || "-";
          document.getElementById("server-os").textContent = data.osVersion || "-";
        }
      } catch (err) {
        console.error("server-info error", err);
      }
    }

    // Pagination button handlers
    document.getElementById("agents-prev-btn").addEventListener("click", () => {
      if (agentsCurrentPage > 1) {
        agentsCurrentPage--;
        updateAgentsTable();
      }
    });
    document.getElementById("agents-next-btn").addEventListener("click", () => {
      const totalPages = Math.ceil(agentsData.length / PAGE_SIZE);
      if (agentsCurrentPage < totalPages) {
        agentsCurrentPage++;
        updateAgentsTable();
      }
    });

    document.getElementById("status-prev-btn").addEventListener("click", () => {
      if (statusCurrentPage > 1) {
        statusCurrentPage--;
        updateStatusTable();
      }
    });
    document.getElementById("status-next-btn").addEventListener("click", () => {
      const totalPages = Math.ceil(statusData.length / PAGE_SIZE);
      if (statusCurrentPage < totalPages) {
        statusCurrentPage++;
        updateStatusTable();
      }
    });

    document.getElementById("services-prev-btn").addEventListener("click", () => {
      if (servicesCurrentPage > 1) {
        servicesCurrentPage--;
        updateServicesTable();
      }
    });
    document.getElementById("services-next-btn").addEventListener("click", () => {
      const totalPages = Math.ceil(servicesData.length / PAGE_SIZE);
      if (servicesCurrentPage < totalPages) {
        servicesCurrentPage++;
        updateServicesTable();
      }
    });

    initNav();
    loadAll();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
